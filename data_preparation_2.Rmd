---
title: "Project Data Preparation"
author: "J. Hamski"
date: "May 7, 2016"
output: html_document
---

```{r}
# data tidying
library(readxl)
library(dplyr)
library(tidyr)
library(zoo)
# test graphs
library(ggplot2)
```

```{r}
format.year <- function(question.data){
  question.data$date <- question.data$date %>%
    as.character() %>%
    as.yearmon("%Y%m") %>%
    as.Date(frac = 1) 
  
  return(question.data)
}
```


Goal: a 'long' data frame with three columns:
(1) date (2) demographic (3) observation

# All Respondents

Note two tabs required being split into separate tabs: Credit availability and Household (HH) financial situation. 
```{r}
tabs <- c("Inflation expectations", "Inflation uncertainty", "Home price expectations", "Home price uncertainty", "Commodity expectations", "Earnings growth", "Earnings uncertainty", "Job separation expectation", "Job finding expectations", "Unemployment Expectations", "Moving expectations", "HH Income Change", "HH Spending Change", "Taxes Change", "Credit availability Year Ago", "Credit availability Year Ahead", "Delinquency expectations", "Interest rate expectations", "HH financial situation Year Ago", "HH financial situation Year Ahe", "Stock Prices", "Government debt")
```

```{r}

build.dataset.all <- function(tab){
  question.data <- read_excel('FRBNY-SCE-Data.xls', sheet = tab, na = "NA", skip = 3)
  
  question.data$Question <- tab
  
  question.data <- format.year(question.data)
  
  print(colnames(question.data))
  
  second.to.last <- ncol(question.data) - 1
  
  question.data <- gather(question.data, "survey", "results", 2:second.to.last)

  return(question.data)
  }
```

```{r}
data.all <- lapply(tabs, FUN = build.dataset.all)

data.all <- rbind_all(data.all)
```



# Demographic Breakout
```{r}
data.demo.inflation <- read_excel('FRBNY-SCE-Data.xls', sheet = 'Inflation expectations Demo', na = "NA", skip = 3)
# this tab has essentially two tables side by side
data.demo.inflation.1yr <- data.demo.inflation[1:16]
data.demo.inflation.1yr$Question <- "Median One Year Ahead Inflation Rate Expectation"
data.demo.inflation.3yr <- data.demo.inflation[17:32]
data.demo.inflation.3yr$Question <- "Median Three Year Ahead Inflation Rate Expectation"

data.demo.inflation.1yr$date <- data.demo.inflation.1yr$date %>%
  as.character() %>%
  as.yearmon("%Y%m") %>%
  as.Date(frac = 1)

data.demo.inflation.3yr$date <- data.demo.inflation.3yr$date %>%
  as.character() %>%
  as.yearmon("%Y%m") %>%
  as.Date(frac = 1)
```

```{r}
data.demo <- data.demo.inflation.1yr %>% gather("Demographic", "results", 2:16)
data.demo <- rbind(data.demo, data.demo.inflation.3yr %>% gather("Demographic", "results", 2:16))
```



```{r}
save(data.all, file = "ConsumerExpectationsExplorer/data_all.Rda")
save(data.demo, file = "ConsumerExpectationsExplorer/data_demo.Rda")

```

